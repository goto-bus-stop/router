[[profile.default.overrides]]
# These are known flaky tests according to the test flakiness report provided
# in CircleCI insights, based on the `dev` branch:
#
# https://app.circleci.com/insights/github/apollographql/router/workflows/ci_checks/tests
#
# We will retry these tests up to 2 additional times. Retry counts are recorded.
# Items on this list should be prioritized to get improved and removed from this
# list at the time they are fixed.
#
# Frankly, it may be best to just retry all tests in the apollo-router::integration_tests
# module, as they have a high failure rate, in general.
retries = 2
filter = '''
   test(axum_factory::axum_http_server_factory::tests::request_cancel_log)
or test(plugins::telemetry::metrics::apollo::test::apollo_metrics_enabled)
or test(plugins::telemetry::tests::it_test_prometheus_metrics)
or test(test_client_name)
or test(api_schema_hides_field)
or test(integration::batching::it_handles_single_request_cancelled_by_coprocessor)
or test(integration::file_upload::it_fails_with_file_count_limits)
or test(integration::redis::connection_failure_blocks_startup)
or test(integration::redis::entity_cache)
'''

[profile.ci]
# Print out output for failing tests as soon as they fail, and also at the end
# of the run (for easy scrollability).
failure-output = "immediate-final"

# Repeat non-pass status at the end so they’re easier to find.
final-status-level = "skip"

# Do not cancel the test run on the first failure.
fail-fast = false

# Each test should take much less than 2 minute
slow-timeout = { period = "30s", terminate-after = 4 }

# Write to output for persistence to CircleCI
[profile.ci.junit]
path = "junit.xml"

# Integration tests require more than one thread. The default setting of 1 will cause too many integration tests to run
# at the same time and causes tests to fail where timing is involved.
# This filter applies only to to the integration tests in the apollo-router package.
[[profile.ci.overrides]]
filter = 'test(/^apollo-router::/)'
threads-required = 4
